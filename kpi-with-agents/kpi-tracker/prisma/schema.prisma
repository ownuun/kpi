// KPI Management System - Database Schema
// Generated by Database Engineer Agent

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ========================================
// Core Models
// ========================================

/// Business lines (외주, B2B, ANYON)
model BusinessLine {
  id          String   @id @default(cuid())
  name        String   @unique // "외주", "B2B", "ANYON"
  description String?
  color       String?  // Hex color for UI
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  kpis           KPI[]
  dashboards     Dashboard[]
  snsPosts       SnsPost[]
  landingVisits  LandingVisit[]
  leads          Lead[]
  meetings       Meeting[]
  deals          Deal[]
  emailCampaigns EmailCampaign[]

  @@map("business_lines")
}

/// KPI Definitions
model KPI {
  id             String   @id @default(cuid())
  name           String   // "월 매출", "신규 리드", "전환율"
  description    String?
  unit           String   // "원", "명", "%"
  targetValue    Float?   // 목표값
  currentValue   Float?   // 현재값 (최신 데이터 포인트에서 자동 업데이트)
  measurementType String // daily, weekly, monthly
  category       String?  // "매출", "마케팅", "영업"
  isActive       Boolean  @default(true)

  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  dataPoints     DataPoint[]
  dashboardItems DashboardItem[]

  @@index([businessLineId])
  @@index([isActive])
  @@index([measurementType])
  @@map("kpis")
}

/// Time-series data points for KPIs
model DataPoint {
  id        String   @id @default(cuid())
  value     Float    // 측정값
  timestamp DateTime @default(now()) // 측정 시간
  note      String?  // 메모 (선택)
  source    String?  // 데이터 출처 (manual, api, auto)

  // KPI
  kpiId     String
  kpi       KPI      @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([kpiId])
  @@index([timestamp])
  @@index([kpiId, timestamp]) // Composite for time-series queries
  @@map("data_points")
}

/// Custom dashboards
model Dashboard {
  id          String   @id @default(cuid())
  name        String   // "외주 주간 대시보드", "B2B 월간 리포트"
  description String?
  layout      String?    // Dashboard layout config (grid positions) - JSON string
  isDefault   Boolean  @default(false)

  // Business line
  businessLineId String?
  businessLine   BusinessLine? @relation(fields: [businessLineId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  items       DashboardItem[]

  @@index([businessLineId])
  @@index([isDefault])
  @@map("dashboards")
}

/// Dashboard items (widgets)
model DashboardItem {
  id           String   @id @default(cuid())
  type         String // chart, metric, table, text
  title        String?
  config       String?    // Widget-specific config (chart type, colors, etc.) - JSON string
  position     String?    // Position in grid (x, y, w, h) - JSON string

  // Dashboard
  dashboardId  String
  dashboard    Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  // KPI (optional - for metric/chart widgets)
  kpiId        String?
  kpi          KPI?     @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([dashboardId])
  @@index([kpiId])
  @@map("dashboard_items")
}

// ========================================
// Funnel Models (SNS → Landing → Lead → Meeting → Deal)
// ========================================

/// SNS Posts (from Postiz)
model SnsPost {
  id          String   @id @default(cuid())
  platform    String   // "linkedin", "facebook", "instagram", "youtube", etc.
  postId      String?  // External platform post ID
  content     String   // Post content
  mediaUrls   String?  // JSON array of media URLs
  publishedAt DateTime
  
  // UTM parameters
  utmSource   String?  // Platform name
  utmMedium   String?  // "social"
  utmCampaign String?  // Campaign name
  
  // Statistics (auto-collected by n8n)
  views       Int      @default(0)
  likes       Int      @default(0)
  comments    Int      @default(0)
  shares      Int      @default(0)
  clicks      Int      @default(0) // Link clicks
  
  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  landingVisits LandingVisit[]
  
  @@index([businessLineId])
  @@index([platform])
  @@index([publishedAt])
  @@map("sns_posts")
}

/// Landing page visits
model LandingVisit {
  id          String   @id @default(cuid())
  
  // UTM tracking
  utmSource   String?  // Where visitor came from
  utmMedium   String?  // Medium (social, email, etc.)
  utmCampaign String?  // Campaign name
  utmContent  String?  // Ad variation
  utmTerm     String?  // Keyword
  
  // Visitor info
  ipAddress   String?
  userAgent   String?
  referrer    String?
  
  // Session data
  visitedAt   DateTime @default(now())
  timeOnPage  Int?     // Seconds
  convertedToLead Boolean @default(false)
  
  // SNS post (if came from SNS)
  snsPostId   String?
  snsPost     SnsPost? @relation(fields: [snsPostId], references: [id], onDelete: SetNull)
  
  // Lead (if converted)
  leadId      String?  @unique
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  
  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)
  
  @@index([businessLineId])
  @@index([utmSource])
  @@index([visitedAt])
  @@index([convertedToLead])
  @@map("landing_visits")
}

/// Leads (from Twenty CRM)
model Lead {
  id          String   @id @default(cuid())
  
  // Contact info (from Twenty Person entity)
  name        String
  email       String
  phone       String?
  company     String?
  jobTitle    String?
  city        String?
  
  // Lead status
  status      String   @default("NEW") // NEW, CONTACTED, QUALIFIED, UNQUALIFIED
  source      String?  // Where lead came from
  
  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  landingVisit LandingVisit?
  meetings     Meeting[]
  deals        Deal[]
  
  @@index([businessLineId])
  @@index([status])
  @@index([email])
  @@map("leads")
}

/// Meetings (synced with Google Calendar)
model Meeting {
  id          String   @id @default(cuid())
  title       String
  description String?
  
  // Schedule
  scheduledAt DateTime
  duration    Int      @default(60) // Minutes
  location    String?  // "Zoom", "Office", etc.
  
  // Google Calendar
  calendarEventId String? // Google Calendar event ID
  meetingLink     String? // Zoom/Meet link
  
  // Status
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
  notes       String?  // Meeting notes
  
  // Lead
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([leadId])
  @@index([businessLineId])
  @@index([scheduledAt])
  @@index([status])
  @@map("meetings")
}

/// Deals (from Twenty Opportunity entity)
model Deal {
  id          String   @id @default(cuid())
  name        String   // Deal name
  description String?
  
  // Amount
  amount      Float
  currency    String   @default("KRW")
  
  // Pipeline
  stage       String   @default("PROPOSAL") // PROPOSAL, NEGOTIATION, CONTRACT, WON, LOST
  probability Int?     // 0-100%
  
  // Dates
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  
  // Payment tracking
  depositExpectedAt DateTime? // 입금 예정일
  depositConfirmed  Boolean   @default(false)
  depositAmount     Float?
  depositedAt       DateTime?
  
  // PoC tracking (for B2B)
  hasPoc        Boolean  @default(false)
  pocStartDate  DateTime?
  pocEndDate    DateTime?
  pocStatus     String?  // "IN_PROGRESS", "SUCCESS", "FAILED"
  
  // Subscription (for ANYON B2C)
  isSubscription    Boolean  @default(false)
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?
  
  // Lead
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([leadId])
  @@index([businessLineId])
  @@index([stage])
  @@index([expectedCloseDate])
  @@map("deals")
}

/// Email campaigns (from Mautic)
model EmailCampaign {
  id          String   @id @default(cuid())
  name        String
  subject     String
  content     String   // HTML content
  
  // Campaign info
  sentAt      DateTime?
  status      String   @default("DRAFT") // DRAFT, SCHEDULED, SENT
  
  // Statistics (auto-collected from Mautic)
  recipientCount Int      @default(0)
  openCount      Int      @default(0)
  clickCount     Int      @default(0)
  replyCount     Int      @default(0)
  bounceCount    Int      @default(0)
  
  // Rates (calculated)
  openRate       Float?   // Percentage
  clickRate      Float?   // Percentage
  replyRate      Float?   // Percentage
  
  // Business line
  businessLineId String
  businessLine   BusinessLine @relation(fields: [businessLineId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([businessLineId])
  @@index([status])
  @@index([sentAt])
  @@map("email_campaigns")
}

// ========================================
// Updated Relations for BusinessLine
// ========================================

// Add to BusinessLine model:
// snsPosts       SnsPost[]
// landingVisits  LandingVisit[]
// leads          Lead[]
// meetings       Meeting[]
// deals          Deal[]
// emailCampaigns EmailCampaign[]

// ========================================
// Enums (SQLite uses strings)
// ========================================

// MeasurementType: DAILY, WEEKLY, MONTHLY, QUARTERLY, YEARLY, REALTIME
// WidgetType: LINE_CHART, BAR_CHART, PIE_CHART, METRIC_CARD, TABLE, TEXT, PROGRESS
// LeadStatus: NEW, CONTACTED, QUALIFIED, UNQUALIFIED
// MeetingStatus: SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
// DealStage: PROPOSAL, NEGOTIATION, CONTRACT, WON, LOST
// EmailCampaignStatus: DRAFT, SCHEDULED, SENT
// PocStatus: IN_PROGRESS, SUCCESS, FAILED
