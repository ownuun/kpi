version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: kpi-postgres
    environment:
      POSTGRES_DB: kpi_platform
      POSTGRES_USER: kpi_user
      POSTGRES_PASSWORD: kpi_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - kpi-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: kpi-redis
    ports:
      - "6379:6379"
    networks:
      - kpi-network

  # Postiz (SNS Management)
  postiz:
    image: ghcr.io/gitroomhq/postiz-app:latest
    container_name: kpi-postiz
    environment:
      DATABASE_URL: postgresql://kpi_user:kpi_password@postgres:5432/postiz
      REDIS_URL: redis://redis:6379
      FRONTEND_URL: http://localhost:5000
      BACKEND_INTERNAL_URL: http://postiz:3000
    ports:
      - "5000:3000"
    depends_on:
      - postgres
      - redis
    networks:
      - kpi-network
    restart: unless-stopped

  # Twenty CRM
  twenty:
    image: twentycrm/twenty:latest
    container_name: kpi-twenty
    environment:
      DATABASE_URL: postgresql://kpi_user:kpi_password@postgres:5432/twenty
      REDIS_URL: redis://redis:6379
      ACCESS_TOKEN_SECRET: change-me-to-a-random-string-access
      LOGIN_TOKEN_SECRET: change-me-to-a-random-string-login
      REFRESH_TOKEN_SECRET: change-me-to-a-random-string-refresh
      FILE_TOKEN_SECRET: change-me-to-a-random-string-file
    ports:
      - "3001:3000"
    depends_on:
      - postgres
      - redis
    networks:
      - kpi-network
    restart: unless-stopped

  # n8n (Workflow Automation)
  n8n:
    image: n8nio/n8n:latest
    container_name: kpi-n8n
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=kpi_user
      - DB_POSTGRESDB_PASSWORD=kpi_password
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=admin
      - WEBHOOK_URL=http://localhost:5678/
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - postgres
    networks:
      - kpi-network
    restart: unless-stopped

  # Metabase (Analytics)
  metabase:
    image: metabase/metabase:latest
    container_name: kpi-metabase
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase
      MB_DB_PORT: 5432
      MB_DB_USER: kpi_user
      MB_DB_PASS: kpi_password
      MB_DB_HOST: postgres
    ports:
      - "3002:3000"
    depends_on:
      - postgres
    networks:
      - kpi-network
    restart: unless-stopped

  # Mautic (Email Marketing)
  mautic:
    image: mautic/mautic:latest
    container_name: kpi-mautic
    environment:
      MAUTIC_DB_HOST: postgres
      MAUTIC_DB_USER: kpi_user
      MAUTIC_DB_PASSWORD: kpi_password
      MAUTIC_DB_NAME: mautic
      MAUTIC_TRUSTED_PROXIES: 0.0.0.0/0
    ports:
      - "8080:80"
    volumes:
      - mautic_data:/var/www/html
    depends_on:
      - postgres
    networks:
      - kpi-network
    restart: unless-stopped

networks:
  kpi-network:
    driver: bridge

volumes:
  postgres_data:
  n8n_data:
  mautic_data:
